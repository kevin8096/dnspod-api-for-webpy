#!/usr/bin/env python
# coding: utf-8
import web
import os
import urllib
import json
from mongoengine import connection
from config.settings import urls
from web import utils
from include.dnspod import dnspod


web.config.debug = False

r = web.template.render(os.path.join(os.path.dirname(__file__), 'templates/'))
siteName = 'dnsapi'
header = r.header(siteName)
baseUrl = 'https://dnsapi.cn/'
userInfoApi = baseUrl + 'User.Detail' #用户信息
domainCreate = baseUrl + 'Domain.Create' #添加域名


db = web.database(dbn='mysql',db='test',user='root',pw='')



class Index:
    def GET(self):
         chkLogin()

class Login:
    def GET(self):
        i = web.input()
        errorMsg = ''
        if  i and int(i.error) == 1:
            errorMsg = errorMsgMethod('please check your email or password!')
        chkLogin()
        return r.login(errorMsg)
    def POST(self):
        i = web.input(email='kevin8096@live.com',pwd='2720003')
        if not i.email:
            return 'please check your email'
        if not i.pwd:
            return 'please check your password'
        else:
            api = dnspod(str(i.email),str(i.pwd),userInfoApi)
            returnData = api.apiPost()
            returnData = json.loads(returnData,encoding="utf8")
            if returnData['status']:
                if int(returnData['status']['code']) == 1:
                    session.login = True
                    web.seeother('/list')
                else:
                    web.redirect('/login?error=1')


class List:
    def GET(self):
        if session.get('login',False):
            dataList = [1,2,3,4,5]
            errorMsg = ''
            successMsg = ''
            i = web.input()
            try:
                if i and  int(i.error) == 1:
                    errorMsg = errorMsgMethod('something error!')
            except:
                pass

            try:
                if i and  int(i.success) == 1:
                    successMsg = successMsgMethod('create domain succesed!')
            except:
                pass

            return r.list(dataList,header,errorMsg,successMsg)


class Logout:
    def GET(self):
        session.kill()
        web.seeother('/login')

class DelDomain:
    def GET(self):
        i = web.input()
        if not i.domainId:
            web.seeother('/list')
        else:
            #do del
            return 'success delte'

class AddDomian:
    def GET(self):
        chkLogin()
        a = ''
        return r.add(a,header)

    def POST(self):
        chkLogin()
        isMark = 'no'
        i = web.input()
        if  i.domain:
            if i.light:
                isMark ='yes'
            api = dnspod('kevin8096@live.com',2720003,domainCreate,domain=i.domain,is_mark=isMark)
            returnData = api.apiPost()
            returnData = json.loads(returnData,encoding="utf8")
            if returnData['status']:
                if int(returnData['status']['code']) == 1:
                    web.seeother('/list?success=1')
                else:
                    web.redirect('/add?error=1')




def chkLogin():
        if not session.get('login',False):
            web.redirect('/login')


def errorMsgMethod(msg):
    return '<div class="alert alert-danger">'+msg+'</div>'

def successMsgMethod(msg):
    return '<div class="alert alert-success">'+msg+'</div>'


def isset(v):
    try:
        type(eval(v))
    except:
        return 0
    else:
        return 1

app = web.application(urls, globals())
curdir = os.path.dirname(__file__)
session = web.session.Session(app, web.session.DiskStore(curdir + '/' + 'sessions'),)
application = app.wsgifunc()
